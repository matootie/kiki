name: Continuous Delivery

on:
  release:
    types: [published]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Set env
        run: echo ::set-env name=DOCKER_IMAGE_TAG::$(echo ${GITHUB_REF:11})

      - name: Build and push image
        uses: pangzineng/Github-Action-One-Click-Docker@master
        env:
          DOCKER_REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          DOCKER_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Save DigitalOcean kubeconfig
        uses: digitalocean/action-doctl@master
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DO_TOKEN }}
        with:
          args: kubernetes cluster kubeconfig show k8s-cluster-name > $GITHUB_WORKSPACE/.kubeconfig

      - name: Set kubectl context
        uses: azure/k8s-actions/k8s-set-context@master
        with:
          context: ${{ secrets.CLUSTER_NAME }}

      - name: Create Registry secret
        uses: azure/k8s-actions/k8s-create-secret@master
        with:
          container-registry-url: ${{ secrets.REGISTRY_URL }}
          container-registry-username: ${{ secrets.REGISTRY_USERNAME }}
          container-registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          secret-name: container-registry-secrets

      - name: Deploy to Kubernetes
        uses: azure/k8s-actions/k8s-deploy@master
        with:
          manifests: |
            manifests/release-deployment.yaml
          images: |
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/kiki:${DOCKER_IMAGE_TAG}
          imagepullsecrets: |
            container-registry-secrets
